<!DOCTYPE html>
<html lang="en" class="h-100">
<head>
    <meta charset="UTF-8">
    <title>Map</title>
    <link rel="stylesheet" href="https://unpkg.com/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="anonymous"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.js"
            integrity="sha256-tAYlAN1qth0gHGwN3e85JLm82kzjYc4ozrVjBfO+7nM="
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/iatkin/leaflet-svgicon/svg-icon.js"
            integrity="sha256-434ozol5hO27OHoz3fu7XjnM/Gs6e4Fni8VVJj/Fk2k="
            crossorigin="anonymous"></script>
</head>
<body class="h-100">
<div id="map" class="h-100"></div>
<script>
    const map = L.map('map');
    const layerControl = L.control.layers().addTo(map);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    (async function() {
        const url = 'data.json';
        const response = await fetch(url);
        const json = await response.json();
        const points = json.sort((a, b) => a.timestamp - b.timestamp);

        let latlngs = [];
        let pointGroups = {};

        for (const point of points) {
            latlngs = [
                ...latlngs,
                [point.lat, point.lon],
            ];
            pointGroups[point.key] = [
                ...pointGroups[point.key] || [],
                point,
            ];
        }

        map.fitBounds(latlngs);

        for (const [key, points] of Object.entries(pointGroups)) {
            const color1 = '#' + key.substring(0, 6);
            const color2 = '#' + key.substring(6, 12);

            const icon = new L.DivIcon.SVGIcon({
                circleText: key.substring(0, 2).toUpperCase(),
                color: color1,
                fontColor: color2,
            });

            const polyline = L.polyline.antPath(points.map(point => [point.lat, point.lon]), {
                color: color1,
                delay: 1000,
                pulseColor: color2,
            });

            const markers = points.map(point =>
                L.marker([point.lat, point.lon], {
                    icon,
                }).bindTooltip(point.isodatetime)
            );

            const layerGroup = L.layerGroup([
                ...markers,
                polyline,
            ]).addTo(map);

            layerControl.addOverlay(layerGroup, key);
        }
    })();
</script>
</body>
</html>
